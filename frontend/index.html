<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RSS‑AI 控制台</title>
  <script>
    (function() {
      try {
        const stored = localStorage.getItem('theme');
        if (stored === 'light' || stored === 'dark') {
          document.documentElement.dataset.theme = stored;
        }
      } catch (_) {}
    })();
  </script>
  <link rel="stylesheet" href="./styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div id="app">
    <header class="header">
      <div class="brand">RSS‑AI</div>
      <div class="header-actions">
        <nav class="nav" aria-label="页面切换">
          <button class="tab-btn primary-tab active" type="button" data-tab="content" aria-selected="true">内容</button>
          <button class="tab-btn primary-tab" type="button" data-tab="reports" aria-selected="false">定时汇总报告</button>
        </nav>
        <div class="header-utilities">
          <button id="themeToggle" class="utility-btn theme-toggle" type="button" aria-label="切换到白天模式" title="切换到白天模式">🌞 白天</button>
          <button class="utility-btn primary-tab" type="button" data-tab="settings" aria-selected="false">设置</button>
        </div>
      </div>
    </header>

    <main>
      <div class="mobile-tab-switch" role="tablist" aria-label="查看内容或汇总">
        <button class="mobile-tab-option active" type="button" role="tab" data-tab="content" aria-selected="true">内容</button>
        <button class="mobile-tab-option" type="button" role="tab" data-tab="reports" aria-selected="false">定时汇总报告</button>
      </div>
      <section id="content" class="tab active">
        <div class="toolbar">
          <div class="toolbar-row row1">
            <select id="feedSelect" class="select"></select>
            <button id="refreshBtn" class="primary">手动抓取</button>
          </div>
          <div class="toolbar-row row2">
            <label class="switch as-btn">
              <input type="checkbox" id="autoRefresh" />
              <span>自动刷新</span>
            </label>
            <label class="switch as-btn"><input type="checkbox" id="forceFetch" /><span>强制抓取</span></label>
            <span id="statusText"></span>
          </div>
        </div>
        <div id="articles" class="list"></div>
        <div class="pager">
          <button id="prevPage">上一页</button>
          <span id="pageInfo"></span>
          <button id="nextPage">下一页</button>
        </div>
      </section>

      <section id="settings" class="tab">
        <form id="settingsForm" class="settings-form">
          <fieldset>
            <legend>抓取与存储</legend>
            <label>
              抓取间隔（分钟）
              <input type="number" id="interval" min="1" max="1440" />
            </label>
            <label>
              存储上限（条）
              <input type="number" id="maxItems" min="10" max="50000" />
            </label>
            <label>
              单源抓取上限（每次）
              <input type="number" id="perFeedLimit" min="1" max="1000" />
            </label>
            <label>
              RSS 列表（每行一个URL）
              <textarea id="feeds" rows="6" placeholder="https://..."></textarea>
            </label>
            <label>
              关键词筛选（每行一个，留空表示不过滤）
              <textarea id="filterKeywords" rows="4" placeholder="例如：科技\n芯片"></textarea>
            </label>
            <label class="switch">
              <input type="checkbox" id="useArticlePage" />
              <span>使用原文抽取正文</span>
            </label>
            <label>
              原文抓取超时（秒）
              <input type="number" id="articleTimeout" min="5" max="60" />
            </label>
          </fieldset>

          <fieldset>
            <legend>AI 设置（OpenAI兼容）</legend>
            <label>
              启用AI
              <input type="checkbox" id="aiEnabled" />
            </label>
            <label>
              API Base URL
              <input type="text" id="aiBaseUrl" placeholder="https://api.openai.com/v1" />
            </label>
            <label>
              API Key
              <input type="password" id="aiApiKey" placeholder="sk-...（留空不变）" />
            </label>
            <label>
              模型
              <input type="text" id="aiModel" placeholder="gpt-4o-mini" />
            </label>
            <label>
              温度（0-1）
              <input type="number" step="0.1" min="0" max="1" id="aiTemp" />
            </label>
            <label>
              System Prompt（系统提示词）
              <textarea id="aiSystemPrompt" rows="5" placeholder="自定义系统提示词"></textarea>
            </label>
            <label>
              User Prompt 模板（可用 {title},{link},{pub_date},{author},{content} 占位符）
              <textarea id="aiUserPrompt" rows="8" placeholder="自定义用户提示词模板"></textarea>
            </label>
          </fieldset>

          <fieldset>
            <legend>Telegram 推送</legend>
            <label>
              启用Telegram推送
              <input type="checkbox" id="tgEnabled" />
            </label>
            <label>
              Bot Token
              <input type="password" id="tgToken" placeholder="（留空不变）" />
            </label>
            <label>
              Chat ID / Channel
              <input type="text" id="tgChatId" placeholder="@your_channel 或 chat id" />
            </label>
            <label class="switch">
              <input type="checkbox" id="tgPushSummary" />
              <span>推送抓取汇总到 Telegram</span>
            </label>
          </fieldset>

          <fieldset>
            <legend>定时汇总报告</legend>
            <label class="switch">
              <input type="checkbox" id="reportHourly" />
              <span>启用小时报（每整点，覆盖过去1小时）</span>
            </label>
            <label class="switch">
              <input type="checkbox" id="reportDaily" />
              <span>启用日报（每日00:00，覆盖过去24小时）</span>
            </label>
            <label>
              报告 AI 超时时间（秒）
              <input type="number" id="reportTimeout" min="10" max="300" />
            </label>
            <label>
              报告 System Prompt
              <textarea id="reportSystemPrompt" rows="5" placeholder="自定义报告系统提示词"></textarea>
            </label>
            <label>
              报告 User Prompt 模板（可用 {label},{timeframe},{article_count},{feed_stats},{article_details} 占位符）
              <textarea id="reportUserPrompt" rows="8" placeholder="自定义报告用户提示词模板"></textarea>
            </label>
          </fieldset>

          <fieldset>
            <legend>安全</legend>
            <label>
              当前密码
              <input type="password" id="currentPassword" inputmode="numeric" pattern="[0-9]{4}" placeholder="必填，4位数字" autocomplete="current-password" />
            </label>
            <label>
              新密码（可选）
              <input type="password" id="newPassword" inputmode="numeric" pattern="[0-9]{4}" placeholder="4位数字" autocomplete="new-password" />
            </label>
            <p class="form-hint">保存设置需输入当前密码。新密码需为4位数字，留空则保持不变。</p>
          </fieldset>

          <div class="actions">
            <button type="submit" class="primary">保存设置</button>
            <span id="saveStatus"></span>
          </div>
        </form>
      </section>

      <section id="reports" class="tab">
        <div class="toolbar">
          <div class="toolbar-row row1">
            <div class="segment-switch" role="tablist" aria-label="筛选定时汇总类型">
              <button class="segment-option active" type="button" role="tab" data-report-filter="hourly" aria-selected="true">小时报</button>
              <button class="segment-option" type="button" role="tab" data-report-filter="daily" aria-selected="false">日报</button>
            </div>
          </div>
          <div class="toolbar-row row2">
            <button id="generateHourlyReport" class="primary">生成小时报</button>
            <button id="generateDailyReport" class="primary">生成日报</button>
          </div>
        </div>
        <div id="reportsList" class="list"></div>
        <div class="pager">
          <button id="reportPrevPage">上一页</button>
          <span id="reportPageInfo"></span>
          <button id="reportNextPage">下一页</button>
        </div>
      </section>
    </main>

    <div id="toast" class="toast">已保存</div>
    <button id="toTop" class="to-top" title="回到顶部">↑</button>

    <div id="modal" class="modal">
      <div class="modal-dialog">
        <div class="modal-header">
          <h3 id="modalTitle"></h3>
          <button class="ghost" data-close="1">✕</button>
        </div>
        <div class="modal-body">
          <div id="modalMeta" class="meta" style="margin-bottom:8px"></div>
          <div id="modalSummary" class="summary"></div>
        </div>
        <div class="modal-footer">
          <a id="modalLink" class="link" target="_blank" rel="noopener">在新标签打开原文</a>
          <button class="ghost" data-close="1">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./app.js"></script>
  <script>
    const primaryTabs = Array.from(document.querySelectorAll('.primary-tab'));
    const mobileTabs = Array.from(document.querySelectorAll('.mobile-tab-option'));

    function setActiveTab(tab) {
      const target = document.getElementById(tab);
      if (!target) return;
      primaryTabs.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
        btn.setAttribute('aria-selected', btn.dataset.tab === tab ? 'true' : 'false');
      });
      mobileTabs.forEach(btn => {
        const isActive = btn.dataset.tab === tab;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      document.querySelectorAll('.tab').forEach(sec => sec.classList.remove('active'));
      target.classList.add('active');
    }

    primaryTabs.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));
    mobileTabs.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

    const currentTab = document.querySelector('.tab.active')?.id || 'content';
    setActiveTab(currentTab);
  </script>
</body>
</html>
